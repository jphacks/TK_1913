# お辞儀する カコノ小町 / イマノ小町(Unity 編)

![kakono_komachi](https://user-images.githubusercontent.com/33016470/67640261-e3feee80-f93c-11e9-95f0-34aeeaf0f22f.gif)
![imano_komachi](https://user-images.githubusercontent.com/42725796/67636457-00d2fc00-f914-11e9-929c-84d53bf5d39c.png)

## カコノ小町

担当: [@hide](https://github.com/hdfln)
ソースコード: `/unity/kakonokomachi/*

### 製品概要

製品ページ: <http://komachi.hongo.wide.ad.jp/>

気圧センサによる姿勢推定をアーカイブし、過去のお辞儀を繰り返しミライ小町が再現してくれる Web アプリケーション。

### 設計概要

過去のお辞儀IDをURLパラメータから読み取りWebGLに渡す。
お辞儀IDから深さを記録した離散データを取得し、毎フレームデータを補完して小町の姿勢を制御した。

### 開発指針

お辞儀の姿勢を角度パラメータを与えて制御する。

### 課題

#### お辞儀アニメーション

そもそも、アバターのどの部位がお辞儀に関係するかがわからなかったので、まずは、アバターの各部位を地道に動かして、どの部位がお辞儀に関係する部位かを探った。

各部位の制御にはMuscleを用いた。そこで、角度とMuscleの対応関係を調べた。すると、Muscleパラメータを線形に変化させても、お辞儀の角度は線形に変化しなかった。そこで、手動で地道にどのような対応になっているかを探った。

---

## イマノ小町

担当: [@inox-ee](https://github.com/inox-ee)
ソースコード: `/unity/imanokomachi/*`

### 製品概要

製品ページ: <http://komachi.hongo.wide.ad.jp/imanokomachi>

リアルタイムで気圧センサによる姿勢推定を行い、ミライ小町にお辞儀の再現をしてもらう Web アプリケーション。

### 設計概要

**MQTT**プロトコルを使用した **Pub/Sub モデル**ネットワークを構築することにより、
ラズパイ上の気圧センサで取得したデータを **WebGL by _Unity_** で低遅延で受信/姿勢推定を行う。

```text
Raspberry Pi ZERO ---> (Publish) ---> Mosquitto(Broker) ---> (Subscribe) ---> WebGL by Unity
```

### 開発目標

以下の 2 つを今 Unity アプリケーションの開発目標として定めた。
なお、これらは 2 日間の開発期間内に実現できた。

- 低遅延応答性の実現
- Web アプリケーションの実現

### 課題

上記開発目標を達成するに向け、以下の 2 つが主な課題となった。

1. ラズパイからの低遅延な気圧データ受信
2. WebGL でビルドされた Unity アプリケーションへの値の受け渡し

#### 課題 1: ラズパイからの低遅延な気圧データ受信

当初の開発予定では、サーバ - Unity 間で **WebSocket** を使う予定であった。
しかし、リアルタイム性のボトルネックとなったのは **ラズパイからサーバへの送信** であることが判明した。気圧センサのデータを毎回 TCP プロトコルでサーバへ POST していては当然パケットが詰まってしまうため、一定時間キューへ溜めてからまとめて POST する設計としていたが、これでは遅延が発生した。

そこでネットワークモデルとして **MQTT プロトコルによる Pub/Sub システム** を構築した。
MQTT プロトコルは 非同期・軽量を特徴とした、IoT 通信の基本的なプロトコルとされている。これを採用したことで、ラズパイから連続的にデータ送信を行ってもバッファが詰まることなくブローカーに Publish 可能となった。
また、ラズパイの **CPU 仕様率** も大幅に削減できた。

#### 課題 2: WebGL でビルドされた Unity アプリケーションへの値の受け渡し

上記の通り Pub/Sub モデルシステムにおいて、WebGL でビルドされた Unity アプリケーションは気圧データの **Subscribe** を行う。
当製品は Web アプリケーションとしての構築を目標としていたため、Unity を WebGL としてビルドした。そのため従来 AssetStore 等で配布されている _Unity-WebSocket_ や、_Unity-MQTT_ のライブラリは使用できない。

そこで ビルドにより生成された `index.html` が JS スクリプトを呼び出すように修正する。
JS スクリプト内において EC2 上に立てた MQTT ブローカへ接続し、気圧値が publish されるのを待機する。
また、subscribe した値は、`gameInstance.SendMessage( "MyObject", "MyFunction", value );` により Unity アプリケーション内の関数へ、引数付きで呼び出すことができることを見つけた。

以上の課題及びそれに対するアプローチを試行錯誤することにより、目的の設計を実現することができた。
